{
  "hash": "ec9807e3d04a8917292606741c273be8",
  "result": {
    "markdown": "---\ntitle: \"College Admissions: Task 1 over Time\"\noutput: html_document\nbibliography: ../bib/CFA.bib\nbiblio-style: unsrt\n---\n\n\n\n\n## College Admissions: Bias Detection over Time\n\nIn this vignette, we analyze a synthetic College Admission dataset, to demonstrate how the task of bias detection could be performed over time, in a university. In particular, we have the following story.\n\nA university in the United States admits applicants every year. The university is interested in quantifying discrimination in the admission process and track it over time, between 2010 and 2020. The data generating process changes over time, and can be described as follows. Let $X$ denote gender ($x_0$ female, $x_1$ male). Let $Z$ be the age at time of application ($Z = 0$ under 20 years, $Z = 1$ over 20 years) and let $W$ denote the department of application ($W = 0$ for arts\\&humanities, $W = 1$ for sciences). Finally, let $Y$ denote the admission decision ($Y = 0$ rejection, $Y = 1$ acceptance). The application process changes over time and is given by\n$$\n\\begin{empheq}[left ={\\mathcal{F}(t), P(U): \\empheqlbrace}]{align}\n\t\t        X & \\gets \\mathbb{1} ( U_X < 0.5 + 0.1U_{XZ})\\label{eq:fcb2-x}\\\\\n\t\t        Z & \\gets \\mathbb{1} (U_Z < 0.5 + \\kappa(t) U_{XZ})  \\\\ \n\t\t        W & \\gets \\mathbb{1} (U_W < 0.5 + \\lambda(t) U_{XZ})  \\\\ \n\t\t        Y & \\gets \\mathbb{1} (U_Y < 0.1 + \\alpha(t)X + \\beta(t)W + 0.1Z). \\label{eq:fcb2-y} \\\\\n\t\t        \\nonumber\\\\\n \t\t            U_{XZ} &\\in \\{0,1\\}, P(U_{XZ} = 1) = 0.5, \\\\\n \t\t            U_X &, U_Z, U_W, U_Y \\sim \\text{Unif}[0, 1].       \n\\end{empheq}\n$$\nThe coefficients $\\kappa(t), \\lambda(t), \\alpha(t), \\beta(t)$ change every year, and obey the following dynamics:\n$$\n\\begin{align}\n    \\kappa(t+1) &= 0.9\\kappa(t) \\\\\n    \\lambda(t+1) &= \\lambda(t) (1 - \\beta(t)) \\\\\n    \\beta(t+1) &= \\beta(t) (1 - \\lambda(t)) f(t), f(t) \\sim \\text{Unif}[0.8, 1.2] \\\\\n    \\alpha(t+1) &= 0.8\\alpha(t).\n\\end{align}\n$$\nThe equations can be interpreted as follows. The coefficient $\\kappa(t)$ decreases over time, meaning that the overall age gap between the groups decreases. The coefficient $\\lambda(t)$ decreases compared to the previous year, by an amount dependent on $\\beta(t)$. In words, the rate of application to arts\\&humanities departments decreases if these departments have lower overall admission rates (i.e., students are less likely to apply to departments that are hard to get into). Further, $\\alpha(t)$, which represents gender bias, decreases over time. Finally, $\\beta(t)$ represent the increase in the probability of admission when applying to a science department. Its value depends on the value from the previous year, multiplied by $(1 - \\lambda(t))$ and the random variable $f(t)$. Multiplication by the former factor describes the mechanism in which the benefit of applying to a science department decreases if a larger proportion of students apply for it. The latter factor describes a random variation over time which describes how well (in relative terms) the science departments are funded, and can be seen as depending on research and market dynamics in the sciences.\n\nWe now create functions for generating synethetic data as described above:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_adm <- function(n, cfs, kap = cfs[[\"kap\"]], lam = cfs[[\"lam\"]],\n                    alf = cfs[[\"alf\"]], bet = cfs[[\"bet\"]]) {\n\n  u_xz <- rbinom(n, size = 1, prob = 0.5)\n  x <- rbinom(n, size = 1, prob = 0.5 + 0.1 * u_xz)\n  z <- rbinom(n, size = 1, prob = 0.5 + kap * u_xz)\n  d <- rbinom(n, size = 1, prob = 0.5 + lam * x)\n  y <- rbinom(n, size = 1, prob = 0.1 + alf * x + bet * d + 0.1 * z)\n\n  data.frame(x, z, d, y)\n\n}\n\ncfs_nxt <- function(cfs, kap = cfs[[\"kap\"]], lam = cfs[[\"lam\"]],\n                    alf = cfs[[\"alf\"]], bet = cfs[[\"bet\"]]) {\n\n  kapt <- kap * 0.9\n  lamt <- lam * (1 - bet)\n  bett <- bet * (1 - lam) * runif(1, 0.8, 1.2)\n  alft <- alf * 0.8\n\n  list(kap = kapt, lam = lamt, alf = alft, bet = bett)\n\n}\n```\n:::\n\n\nThe head data scientist at the university decides to use the Fairness Cookbook for performing bias quantification. The SFM projection of the causal diagram $\\mathcal{G}$ of the dataset is given by\n$$\n\\begin{equation}\n\t    \\Pi_{\\text{SFM}}(\\mathcal{G}) = \\langle X = \\lbrace X \\rbrace,  Z = \\lbrace Z \\rbrace, W = \\lbrace W\\rbrace, Y = \\lbrace Y \\rbrace\\rangle.\n\t\\end{equation}\n$$\nAfter that, the analyst estimates the quantities\n$$\n\\begin{align}\n    x\\text{-DE}^{\\text{sym}}_{x}(y \\mid x_0), x\\text{-DE}^{\\text{sym}}_{x}(y \\mid x_0), \\text{ and } x\\text{-SE}_{x_1, x_0}(y) \\;\\;\\; \\forall t \\in \\{2010, \\dots, 2020\\}.\n\\end{align}\n$$\n\nThe following code generates the data, obtains the ground truth causal fairness measures, and also performs the `fairness_cookbook()` at each step.\n\n\n::: {.cell hash='college-admissions-t1_cache/html/fig-north-cookbook_f01571af72ff757f4516421b68476d3c'}\n\n```{.r .cell-code}\ncol_adm_tim <- function(n, cfs) {\n\n  dat <- bqn <- gtr <- list()\n\n  for (t in seq_len(10)) {\n\n    # generate data for given year\n    dat[[t]] <- col_adm(n, cfs)\n\n    # compute decomposition\n    bqn[[t]] <- fairness_cookbook(dat[[t]], X = \"x\", Z = \"z\", W = \"d\", Y = \"y\",\n                                  x0 = 0, x1 = 1)\n\n    # get ground truth\n    gtr[[t]] <- c(cfs$alf, -(cfs$bet * cfs$lam),\n                  0.1 * ( (0.125 + 0.2 * (0.5 + cfs$kap))/(0.45) -\n                             (0.125 + 0.4 * (0.5 + cfs$kap))/(0.55) ))\n\n    # update the coefficients for each year\n    cfs <- cfs_nxt(cfs)\n\n  }\n\n  list(dat = dat, bqn = bqn, gtr = gtr)\n\n}\n\ncfs <- list(kap = 0.3, lam = 0.2, alf = 0.1, bet = 0.3)\n\nset.seed(22)\nres <- col_adm_tim(n = 5000L, cfs = cfs)\n\notp <- c()\nfor (t in seq_along(res[[\"bqn\"]])) {\n\n  x <- res[[\"bqn\"]][[t]]\n  x_tr <- res[[\"gtr\"]][[t]]\n  add_row <- data.frame(Spurious = x$measures$CtfSE[1],\n                        Indirect = x$measures$CtfIE[1],\n                        Direct = x$measures$CtfDE[1],\n                        Spurious_True = x_tr[3],\n                        Indirect_True = x_tr[2],\n                        Direct_True = x_tr[1],\n                        Year = 2010+t)\n\n  otp <- rbind(otp, add_row)\n\n}\n\ndf <- reshape2::melt(otp, id.vars = \"Year\", variable.name = \"Measure\")\ndf$Meas <- gsub(\"_.*\", \"\", df$Measure)\ndf$whc <- ifelse(grepl(\"_\", df$Measure), \"True (population)\",\n                 \"Estimated (from sample)\")\n\nggplot(df, aes(x = Year, y = value, color = Meas, linetype = whc)) +\n  geom_line() + geom_point() + theme_bw() +\n  ggtitle(\"Bias Quantification Over Time - College Admissions\") +\n  ylab(\"Value\") + scale_y_continuous(labels = scales::percent,\n                                     limits = c(-0.1, 0.15)) +\n  scale_x_continuous(breaks = seq(2010, 2020)) +\n  theme(\n    legend.position = \"bottom\",\n    legend.box.background = element_rect(),\n    legend.box = \"horizontal\"\n  ) + scale_linetype_discrete(name = \"Quantity\") +\n  scale_color_discrete(name = \"Effect\")\n```\n\n::: {.cell-output-display}\n![Tracking bias over time in the synthetic College Admissions dataset from Example 5.2, between years 2010 and 2020. Both the estimated values from simulated samples (solid line) and the true population values (dashed lines) are shown, for direct (red), indirect (green), and spurious (blue) effects.](college-admissions-t1_files/figure-html/fig-north-cookbook-1.png){#fig-north-cookbook width=768}\n:::\n:::\n\n\nThe temporal dynamics of the estimated measures of discrimination (together with the ground truth values obtained from the SCM $\\mathcal{M}_t$) are shown graphically in @fig-north-cookbook.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}